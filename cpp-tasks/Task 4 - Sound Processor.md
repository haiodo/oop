# ФИТ НГУ, курс ООП

## Задача 4. Sound Processor

Написать программу, которая получает на вход один или несколько звуковых файлов формата WAV и текстовый файл с описанием преобразований. Программа последовательно применяет конвертеры к звуковому потоку и сохраняет результат в выходной WAV-файл.

Запуск программы:

```
sound_processor -c <config.txt> <output.wav> <input1.wav> [<input2.wav> ...]
sound_processor -h | --help
```

- Ключ -h/--help несовместим с -c.
- При -c параметры обязательны: файл конфигурации, выходной файл, хотя бы один входной файл.

WAV-файл содержит заголовок и данные — последовательность сэмплов (амплитуда сигнала во времени). Частота — сэмплов в секунду. Последовательность сэмплов далее называется потоком (не путать с потоками ввода/вывода).

### Поддерживаемый формат WAV (вход и выход)

- Контейнер RIFF/WAVE.
- Подчинённый chunk fmt:
  - AudioFormat = 1 (PCM, без кодирования).
  - NumChannels = 1 (моно).
  - SampleRate = 44100 Гц.
  - BitsPerSample = 16 (signed, little-endian).
  - BlockAlign, ByteRate соответствуют вышеуказанным параметрам.
- Chunk data присутствует и согласован по размеру.
- Семпл — целое int16 в диапазоне [-32768, 32767], тишина — 0.
- При записи результата достаточно минимально необходимого корректного заголовка (RIFF, fmt, data) с правильными размерами.

Для конвертации из другого формата в нужный можно использовать ffmpeg:

```
ffmpeg -i input.any -f wav -bitexact -acodec pcm_s16le -ar 44100 -ac 1 output_mono_16bit.wav
```

### Конвертеры

Конвертер — компонент, принимающий на вход один или несколько потоков (основной + дополнительные) и выдающий один выходной поток. Конвертер имеет параметры.

Обязательные конвертеры:

1. Заглушить интервал (mute)

- Смысл: занулить (сделать тишину) в указанном интервале времени.
- Параметры: start end (секунды, вещественные числа).
- Поведение:
  - Интервал понимается как [start, end), т.е. end не включительно.
  - Индекс семпла s(t) = round(t \* 44100).
  - Выход имеет ту же длину, что и вход.
  - Если интервал выходит за пределы, он обрезается по границам потока.
  - Если start >= end — изменений нет.

2. Миксер (mix)

- Смысл: примиксовать дополнительный поток к основному, начиная с позиции offset.
- Параметры: $n offset, где $n — ссылка на дополнительный входной файл, offset — секунды (вещественное, по умолчанию 0, если опущен).
- Поведение:
  - Длина выхода = длина основного входного потока.
  - Для каждой позиции i (семпл):
    - Если соответствующий семпл из дополнительного потока существует (учитывая смещение), выходной семпл — среднее двух значений.
    - Иначе — семпл основного потока.
  - Формула (для перекрывающейся области):
    - y[i] = clamp16( round( (x0[i] + x1[i - offsetSamples]) / 2.0 ) )
  - offsetSamples = round(offset \* 44100).
  - Если дополнительный поток длиннее — лишняя часть игнорируется; если короче — за его пределами берётся основной поток без изменений.
  - Обязательна защита от переполнения: clamp16 ограничивает результат в [-32768, 32767].

3. Третий конвертер на ваш выбор

- Требование: должен давать слышимый эффект, иметь минимум 1 параметр.
- Пример (рекомендуется): усиление (gain)
  - Смысл: умножить амплитуду на коэффициент.
  - Параметры: factor (вещественное), например 0.5, 1.5, 2.0.
  - Формула: y[i] = clamp16( round( x[i] \* factor ) ).
- Можно реализовать другой (echo, reverse, tremolo и т.п.), но необходимо задокументировать параметры в справке.

Разрешены дополнительные конвертеры и/или параметры на усмотрение автора. Все доступные конвертеры и их синтаксис должны автоматически появляться в справке (-h).

### Конфигурация (файл config.txt)

- Формат: по одному конвертеру на строку.
- Строки, начинающиеся с #, — комментарии; пустые строки допускаются.
- Токены разделяются пробелами/табами.
- Типы аргументов:
  - Целые (например, 10), вещественные (например, 2.5) — секунды и коэффициенты.
  - Ссылка на поток: $n, где n — номер входного файла, начиная с 1. $1 — это input1.wav, $2 — input2.wav, и т.д.
- Если конвертер требует дополнительный поток (например, mix), он получает его отдельную копию с начала файла. Один и тот же входной файл можно использовать многократно.
- Ошибки конфигурации:
  - Неизвестный конвертер.
  - Неверное число/тип аргументов.
  - Ссылка $n вне диапазона доступных входных файлов.
  - Лишние токены в строке.

Пример:

```
# заглушить первые 30 секунд input1
mute 0 30

# смиксовать с input2, начиная с 10-й секунды
mix $2 10

# заглушить 3-ю минуту (120..180) в уже обработанном потоке
mute 120 180

# увеличить громкость в 1.5 раза
gain 1.5
```

### Правила исполнения

1. Конвертеры применяются последовательно в порядке строк конфигурации.
2. Первый конвертер получает основной входной поток (input1). Результат предыдущего — вход для следующего.
3. Выход последнего конвертера сохраняется в указанный output.wav.
4. Все времена — в секундах, перевод к индексам семплов: round(t \* 44100).
5. Везде, где возможны переполнения int16, требуется насыщение (clamp) к диапазону [-32768, 32767].

### Технические требования

Архитектура и модули:

- Работа с WAV (чтение/запись) и конвертеры — полностью независимые модули.
- «Фабричный метод» для создания конвертеров:
  - Регистрация конвертера по имени, описание, сигнатура параметров, фабрика экземпляров.
  - Набор зарегистрированных конвертеров используется для парсинга конфигурации и генерации справки (-h).
- Разбор конфигурационного файла — отдельный класс (парсер), возвращающий валидированную последовательность операций с типизированными аргументами.
- Исполнитель (pipeline) связывает WAV I/O и конвертеры.

Производительность и память:

- Память не должна зависеть от длины потоков.
- Обработка должна быть потоковой (chunk-based): фиксированный буфер, последовательное чтение/запись.
- Для конвертеров, требующих дополнительный поток, читать вторичный поток независимо, синхронизируя по смещению.

Поддержка форматов и ошибки:

- При неподдерживаемом формате входного файла — корректное сообщение и завершение с соответствующим кодом.
- Использовать исключения C++ для ошибок. Рекомендуемая иерархия:
  - SoundProcessorError (базовое)
    - CmdlineError
    - IoError
    - UnsupportedFormatError
    - ConfigError
    - ProcessingError
- Программа выводит сообщение об ошибке в std::cerr и завершает работу с ненулевым кодом.

Рекомендуемое отображение кодов возврата:

- 0 — успех
- 1 — ошибка аргументов командной строки
- 2 — ошибка ввода/вывода (открытие/чтение/запись)
- 3 — неподдерживаемый формат входного файла
- 4 — ошибка в файле конфигурации (парсинг/валидация)
- 5 — ошибка обработки (во время конвертации)

Справка (-h/--help):

- Должна содержать:
  - Строку использования (usage) и примеры запуска.
  - Описание поддерживаемых форматов WAV.
  - Перечень конвертеров, для каждого: имя, смысл, параметров, синтаксис.
  - Пояснение про ссылки $n и единицы измерения (секунды).
- Содержимое формируется динамически из зарегистрированных конвертеров.

Тестирование:

- Использовать Google Test Framework (подключён в шаблоне CMake).
- Обязательно:
  - Тесты парсера конфигурации (валидные/ошибочные кейсы).
  - Тесты конвертеров на коротких синтетических буферах (mute, mix, ваш конвертер): значения и граничные случаи (смещения, края интервалов, клэмпинг).
  - Тесты WAV I/O (минимальный корректный заголовок, корректность размеров, round-trip на коротком буфере).
- При невозможности слуховой проверки использовать визуальные проверки в редакторе (Audacity).

Сборка:

- Проект собирается с помощью CMake (шаблон см. в папке cpp-template).
- Тесты включены в сборку; добавьте собственные тест-кейсы.

### При сдаче задания продемонстрировать

1. Вывод справки об использовании программы (-h/--help) с динамическим списком конвертеров.
2. Несколько рабочих конфигураций (включая mix с разными смещениями и ваш конвертер).
3. Несколько ошибочных ситуаций:
   - ошибки в аргументах командной строки,
   - неподдерживаемая кодировка/параметры входного WAV,
   - ошибки в файле конфигурации (неизвестный конвертер, неверные аргументы, ссылка $n вне диапазона).
